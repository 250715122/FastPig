# 迅猪（FastPig）功能重构需求文档

## 1. 背景与目标
- 现状：使用 `∈key:desc∈` 自定义分隔格式存储，展示层=存储层，检索以关键词为主，`save` 命令交互直观但扩展性受限。
- 目标：在不改变用户“保存/读取心智”的前提下，实现更可靠的存储、可扩展的检索（关键词+向量）、更丰富的展示（Markdown/公式/高亮/图表）。

## 2. 核心原则
- 保持简单：输入层（命令/GUI）不增加复杂度；保存动作可一步完成。
- 分层解耦：存储、索引/检索、展示三层解耦，彼此可独立演进。
- 渐进增强：先关键词检索与Markdown渲染，后引入向量检索与混合排序。
- 无强制类型：不强制 `type` 字段；以标签（tags）与可选前言区（front‑matter）表达结构化信息；索引阶段派生 computed 属性。

## 3. 术语
- 片段（Snippet）：包含 `key`、`desc`、`tags`、`body` 等字段的知识单元。
- Hybrid 检索：BM25（关键词）与 KNN（向量）结果融合。

## 4. 功能范围
### 4.1 保存与导入
- **全局热键快速收集器**（主要保存方式）：
  - 触发：按下全局快捷键（如 `Alt+S`）
  - 自动捕获：读取剪贴板内容或当前选中文本
  - 智能表单：弹出极简表单，key、desc、tags 自动猜测填入（基于语法高亮与上下文）
  - 快速保存：按 `Enter` 即可保存，操作全程异步，不中断工作流
  - 跨应用通用：支持从浏览器、IDE、文档等任意应用快速收集代码片段

- 自动去重：`key` 唯一；冲突时提示或引导创建别名。
- 版本化：每次保存生成新版本；支持查看历史与回滚。
- 导入迁移：从旧 `∈key:desc∈` 文件一次性导入；支持 JSONL/TOML/Markdown 批量导入。
 - 可选前言区：支持在正文 Markdown 顶部书写 YAML front‑matter，用于自愿提供结构化信息（如 date、participants、project、slug 等）。

### 4.2 存储层
- 选型：SQLite（单文件、事务可靠、易备份）。
- 表设计：
  - `snippets(id TEXT PRIMARY KEY, key TEXT UNIQUE, title TEXT, desc TEXT, tags_json TEXT, body_md TEXT, created_at INTEGER, updated_at INTEGER, version INTEGER, deleted INTEGER DEFAULT 0)`
  - `embeddings(snippet_id TEXT, model TEXT, dim INTEGER, vector BLOB, updated_at INTEGER, PRIMARY KEY(snippet_id, model))`（如采用 Lucene 存向量可省略）
- 说明：正文统一存 Markdown（`body_md`），便于表达代码块、公式、表格与图。支持可选 `front_matter`（YAML 文本）原样存入，索引阶段解析。

### 4.3 索引与检索层
- 全文检索：
  - 方案A：Lucene（推荐，Java 原生，BM25 强大，后续与向量索引一体化）。
- 向量检索：
  - 方案A：Lucene HNSW 向量索引（免本地二进制扩展）。
- 派生属性：索引阶段从正文/前言区/标签中提取 `computedType`、`computedDate`、`computedPeople`、`computedLang`、`hasCode` 等，用于过滤与排序，但不写回主数据。
- 排序策略：Exact key > Prefix key > 主题命中（title/desc/tags） > BM25 > 向量；支持近期使用/收藏加权与显式过滤。
- 结果融合：使用 RRF/线性归一化对全文/向量分数融合；支持权重配置与实验开关。
- 索引更新：保存/编辑/删除后异步更新全文与向量索引；失败自动重试，状态可见。

### 4.4 展示层（渲染与交互）
- 渲染引擎：JavaFX WebView（内嵌 HTML 模板）。
- Markdown 解析：flexmark-java。
- 代码高亮：highlight.js（按需加载语言包）。
- 公式支持：KaTeX（支持 \( \) 与 \[ \] 语法）。
- 流程图/时序图：Mermaid（可选）。
- 主题：明暗主题切换，CSS 变量定制。
- 交互：目录（H2/H3）、复制代码、一键展开/折叠、标签跳转、相似片段推荐。

### 4.5 读取与快捷命令
- 默认“零层筛选”：单次输入查全库，自动解析 key/语言/标签词；无需先选层级。
- 快捷命令：输入框支持 key 精确/前缀命中；`open <key>` 直达；关键词检索回退。
- 列表排序：精确命中 > 前缀命中 > 主题命中 > BM25 > 向量；可配置权重。
- 历史与置顶：最近访问、常用置顶；支持星标与标签过滤。

### 4.6 运行与维护
- 启动：快速加载最小元数据与索引；向量索引惰性加载。
- 备份：SQLite 单文件备份；支持导出 JSONL 归档。
- 日志：操作与错误日志分层记录；可选崩溃报告。
- 配置：`config.json`（索引策略、模型选择、主题、快捷键）。

## 5. 非功能需求
- 性能：千级片段毫秒级检索；万级片段秒级检索；保存操作 < 200ms（异步建索引除外）。
- 跨平台：Windows 优先，兼容 macOS/Linux。
- 可用性：离线可用；无外部服务硬依赖。
- 安全：默认不外发数据；模型可选本地/云端。

## 7. 接口草案
- 全局热键交互
  - `Alt+S`：触发快速收集器弹窗
  - 快速收集器表单：`key`（自动生成）、`desc`（自动猜测）、`tags`（语法识别）、`body`（剪贴板/选中文本）
  - `Enter`：保存并关闭；`Esc`：取消
- 程序 API（Java）
  - `ClipboardService.captureContent()`：获取剪贴板/选中文本
  - `IntelligentParser.guessMetadata(String content)`：智能猜测 key/desc/lang/tags
  - `NoteRepository.save(NoteDto dto)`
  - `SearchService.searchHybrid(String query, SearchOptions opts)`
  - `Renderer.renderMarkdown(String md)`

## 8. 数据模型（DTO 摘要）
```
NoteDto {
  String id;            // UUID
  String key;           // 唯一快捷命令（可选，仅 snippet 场景要求唯一）
  String title;         // 标题
  String desc;          // 摘要/说明
  List<String> tags;    // 标签（含保留标签：snippet/diary/meeting/blog...）
  String bodyMd;        // Markdown 正文
  String frontMatter;   // 可选，YAML 文本（原样存储）
  long createdAt;
  long updatedAt;
  int version;
  // 派生（仅索引层使用，不入库）：computedType/computedDate/computedLang/hasCode...
}
```

## 9. 迁移策略
- 首次运行提供迁移向导：扫描 `src/main/resources/*.txt`，识别 `∈key:desc∈` 片段，转为 `NoteDto` 入库。
- 迁移后旧文件保留为只读；新保存仅入库。

## 10. 风险与应对
- 向量索引体积与耗时：采用小型中文嵌入模型，异步批处理，允许手动触发；支持按需构建与压缩。
- 平台兼容：优先选用 Lucene（避免二进制扩展）；如需 SQLite 向量扩展，提供可选打包并做运行时探测。
- GUI 渲染性能：大文档分段渲染与懒加载；静态资源本地缓存。

---
以上为总体方案，若确认方向，我将进一步细化接口、表结构与里程碑的验收标准。
